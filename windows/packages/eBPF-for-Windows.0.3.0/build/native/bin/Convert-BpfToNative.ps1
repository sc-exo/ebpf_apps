# Copyright (c) Microsoft Corporation
# SPDX-License-Identifier: MIT

param([parameter(Mandatory = $true)] [string] $ProgramName,
    [parameter(Mandatory = $false)] [string] $Type,
    [parameter(Mandatory = $false)] [string] $IncludeDir = "$PSScriptRoot\..\include",
    [parameter(Mandatory = $false)] [string] $BinDir = "$PSScriptRoot",
    [parameter(Mandatory = $false)] [string] $OutDir = "$PWD",
    [parameter(Mandatory = $false)] [string] $Platform = "x64",
    [ValidateSet("Release", "Debug")][parameter(Mandatory = $false)] [string] $Configuration = "Release",
    [parameter(Mandatory = $false)] [bool] $SkipVerification = $false,
    [parameter(Mandatory = $false)] [bool] $KernelMode = $true)

Push-Location $OutDir

$KernelModeProject = '<?xml version="1.0" encoding="utf-8"?> <!--   Copyright (c) Microsoft Corporation   SPDX-License-Identifier: MIT --> <Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">   <ItemGroup Label="ProjectConfigurations">     <ProjectConfiguration Include="Debug|Win32">       <Configuration>Debug</Configuration>       <Platform>Win32</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|Win32">       <Configuration>Release</Configuration>       <Platform>Win32</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Debug|x64">       <Configuration>Debug</Configuration>       <Platform>x64</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|x64">       <Configuration>Release</Configuration>       <Platform>x64</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Debug|ARM">       <Configuration>Debug</Configuration>       <Platform>ARM</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|ARM">       <Configuration>Release</Configuration>       <Platform>ARM</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Debug|ARM64">       <Configuration>Debug</Configuration>       <Platform>ARM64</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|ARM64">       <Configuration>Release</Configuration>       <Platform>ARM64</Platform>     </ProjectConfiguration>   </ItemGroup>   <PropertyGroup Label="Globals">     <ProjectGuid>{172DFDF9-3B0D-44AD-B780-92627EA469A2}</ProjectGuid>     <TemplateGuid>{dd38f7fc-d7bd-488b-9242-7d8754cde80d}</TemplateGuid>     <TargetFrameworkVersion>v4.5</TargetFrameworkVersion>     <MinimumVisualStudioVersion>12.0</MinimumVisualStudioVersion>     <Configuration>Debug</Configuration>     <Platform Condition="''$(Platform)'' == ''''">Win32</Platform>     <RootNamespace>$(ProgramName)</RootNamespace>     <WindowsTargetPlatformVersion>$(LatestTargetPlatformVersion)</WindowsTargetPlatformVersion>     <ProjectName>$(ProgramName)_km</ProjectName>   </PropertyGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />   <PropertyGroup>     <TargetVersion>Windows10</TargetVersion>     <UseDebugLibraries>true</UseDebugLibraries>     <PlatformToolset>WindowsKernelModeDriver10.0</PlatformToolset>     <ConfigurationType>Driver</ConfigurationType>     <DriverType>WDM</DriverType>     <Driver_SpectreMitigation>Spectre</Driver_SpectreMitigation>   </PropertyGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />   <ImportGroup Label="ExtensionSettings">   </ImportGroup>   <ImportGroup Label="PropertySheets">     <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists(''$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props'')" Label="LocalAppDataPlatform" />   </ImportGroup>   <PropertyGroup Label="UserMacros" />   <PropertyGroup />   <PropertyGroup>     <DebuggerFlavor>DbgengKernelDebugger</DebuggerFlavor>     <TargetName>$(ProgramName)</TargetName>   </PropertyGroup>   <ItemDefinitionGroup>     <PreBuildEvent>       <Command>$(BinDir)bpf2c --bpf $(ProgramName).o --sys $(AdditionalOptions) &gt;$(ProgramName)_driver.c</Command>     </PreBuildEvent>     <ClCompile>       <AdditionalIncludeDirectories>$(IncludeDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>       <DisableSpecificWarnings>4189;4245;%(DisableSpecificWarnings)</DisableSpecificWarnings>     </ClCompile>     <Link>       <AdditionalDependencies>Netio.lib;%(AdditionalDependencies)</AdditionalDependencies>     </Link>     <DriverSign>       <FileDigestAlgorithm>SHA256</FileDigestAlgorithm>     </DriverSign>   </ItemDefinitionGroup>   <ItemGroup>     <FilesToPackage Include="$(TargetPath)" />   </ItemGroup>   <ItemGroup>     <ClCompile Include="$(ProgramName)_driver.c" />   </ItemGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />   <ImportGroup Label="ExtensionTargets">   </ImportGroup> </Project>'
$UserModeProject = '<?xml version="1.0" encoding="utf-8"?> <!--   Copyright (c) Microsoft Corporation   SPDX-License-Identifier: MIT --> <Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">   <ItemGroup Label="ProjectConfigurations">     <ProjectConfiguration Include="Debug|Win32">       <Configuration>Debug</Configuration>       <Platform>Win32</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|Win32">       <Configuration>Release</Configuration>       <Platform>Win32</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Debug|x64">       <Configuration>Debug</Configuration>       <Platform>x64</Platform>     </ProjectConfiguration>     <ProjectConfiguration Include="Release|x64">       <Configuration>Release</Configuration>       <Platform>x64</Platform>     </ProjectConfiguration>   </ItemGroup>   <ItemGroup>     <ClCompile Include="$(ProgramName)_dll.c" />   </ItemGroup>   <PropertyGroup Label="Globals">     <VCProjectVersion>16.0</VCProjectVersion>     <Keyword>Win32Proj</Keyword>     <ProjectGuid>{1baf5f74-b71f-4088-8677-f27070302b59}</ProjectGuid>     <RootNamespace>$(ProgramName)dll</RootNamespace>     <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>     <ProjectName>$(ProgramName)_um</ProjectName>   </PropertyGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />   <PropertyGroup>     <ConfigurationType>DynamicLibrary</ConfigurationType>     <UseDebugLibraries>true</UseDebugLibraries>     <PlatformToolset>v142</PlatformToolset>     <CharacterSet>Unicode</CharacterSet>   </PropertyGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />   <ImportGroup Label="ExtensionSettings">   </ImportGroup>   <ImportGroup Label="Shared">   </ImportGroup>   <ImportGroup>     <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists(''$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props'')" Label="LocalAppDataPlatform" />   </ImportGroup>   <PropertyGroup Label="UserMacros" />   <PropertyGroup>     <LinkIncremental>false</LinkIncremental>     <TargetName>$(ProgramName)_um</TargetName>   </PropertyGroup>   <ItemDefinitionGroup Condition="''$(Configuration)|$(Platform)''==''Debug|Win32''">     <ClCompile>       <PreprocessorDefinitions>WIN32;_DEBUG;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>       <ConformanceMode>true</ConformanceMode>       <PrecompiledHeader>NotUsing</PrecompiledHeader>       <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>       <AdditionalIncludeDirectories>$(IncludeDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>       <DisableSpecificWarnings>4189;4245;%(DisableSpecificWarnings)</DisableSpecificWarnings>     </ClCompile>     <Link>       <SubSystem>Windows</SubSystem>       <GenerateDebugInformation>true</GenerateDebugInformation>       <EnableUAC>false</EnableUAC>     </Link>     <PreBuildEvent>       <Command>$(BinDir)bpf2c.exe --bpf $(ProgramName).o --dll $(AdditionalOptions) &gt;$(ProgramName)_dll.c</Command>     </PreBuildEvent>   </ItemDefinitionGroup>   <ItemDefinitionGroup Condition="''$(Configuration)|$(Platform)''==''Release|Win32''">     <ClCompile>       <PreprocessorDefinitions>WIN32;NDEBUG;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>       <ConformanceMode>true</ConformanceMode>       <PrecompiledHeader>NotUsing</PrecompiledHeader>       <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>       <AdditionalIncludeDirectories>$(IncludeDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>       <DisableSpecificWarnings>4189;4245;%(DisableSpecificWarnings)</DisableSpecificWarnings>     </ClCompile>     <Link>       <SubSystem>Windows</SubSystem>       <EnableCOMDATFolding>true</EnableCOMDATFolding>       <OptimizeReferences>true</OptimizeReferences>       <GenerateDebugInformation>true</GenerateDebugInformation>       <EnableUAC>false</EnableUAC>     </Link>     <PreBuildEvent>       <Command>$(BinDir)bpf2c.exe --bpf $(ProgramName).o --dll $(AdditionalOptions) &gt;$(ProgramName)_dll.c</Command>     </PreBuildEvent>   </ItemDefinitionGroup>   <ItemDefinitionGroup Condition="''$(Configuration)|$(Platform)''==''Debug|x64''">     <ClCompile>       <PreprocessorDefinitions>_DEBUG;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>       <ConformanceMode>true</ConformanceMode>       <PrecompiledHeader>NotUsing</PrecompiledHeader>       <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>       <AdditionalIncludeDirectories>$(IncludeDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>       <DisableSpecificWarnings>4189;4245;%(DisableSpecificWarnings)</DisableSpecificWarnings>     </ClCompile>     <Link>       <SubSystem>Windows</SubSystem>       <GenerateDebugInformation>true</GenerateDebugInformation>       <EnableUAC>false</EnableUAC>     </Link>     <PreBuildEvent>       <Command>$(BinDir)bpf2c.exe --bpf $(ProgramName).o --dll $(AdditionalOptions) &gt;$(ProgramName)_dll.c</Command>     </PreBuildEvent>   </ItemDefinitionGroup>   <ItemDefinitionGroup Condition="''$(Configuration)|$(Platform)''==''Release|x64''">     <ClCompile>       <PreprocessorDefinitions>NDEBUG;_WINDOWS;_USRDLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>       <ConformanceMode>true</ConformanceMode>       <PrecompiledHeader>NotUsing</PrecompiledHeader>       <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>       <AdditionalIncludeDirectories>$(IncludeDir);%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>       <DisableSpecificWarnings>4189;4245;%(DisableSpecificWarnings)</DisableSpecificWarnings>     </ClCompile>     <Link>       <SubSystem>Windows</SubSystem>       <EnableCOMDATFolding>true</EnableCOMDATFolding>       <OptimizeReferences>true</OptimizeReferences>       <GenerateDebugInformation>true</GenerateDebugInformation>       <EnableUAC>false</EnableUAC>     </Link>     <PreBuildEvent>       <Command>$(BinDir)bpf2c.exe --bpf $(ProgramName).o --dll $(AdditionalOptions) &gt;$(ProgramName)_dll.c</Command>     </PreBuildEvent>   </ItemDefinitionGroup>   <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />   <ImportGroup Label="ExtensionTargets">   </ImportGroup> </Project>'

# If program name ends with .o, remove the suffix
if ($ProgramName.EndsWith(".o")) {
    $ProgramName = $ProgramName.Substring(0, $ProgramName.Length - 2)
}

# SkipVerification is only supported for Debug.
if ($Configuration -eq "Release" -and $SkipVerification) {
    throw "Invalid parameter. SkipVerification is only supported for Debug builds"
}

if ($null -eq (Get-Command 'msbuild.exe' -ErrorAction SilentlyContinue)) {
    throw "Unable to locate msbuild.exe. This command needs to run within a 'Developer Command Prompt'"
}

$fileExists = Test-Path -Path ("$ProgramName.o")
if (!$fileExists) {
    $errorString = "Can't find program file: " + "$ProgramName.o"
    throw $errorString
}


if ($KernelMode) {
    $ProjectFile = "$ProgramName.vcxproj"
    Set-Content -Path $ProjectFile -Value $KernelModeProject
}
else {
    $ProjectFile = "$ProgramName_um.vcxproj"
    Set-Content -Path $ProjectFile -Value $UserModeProject
}

$AdditionalOptions = If ($SkipVerification) {"--no-verify"} Else {""}

if ($PSBoundParameters.ContainsKey("Type")) {
    $AdditionalOptions += " --type $Type"
}

msbuild /p:BinDir="$BinDir\" /p:OutDir="$PWD\" /p:IncludeDir="$IncludeDir" /p:Configuration="$Configuration" /p:Platform="$Platform" /p:ProgramName="$ProgramName" /p:AdditionalOptions="$AdditionalOptions" $ProjectFile

if ($LASTEXITCODE -ne 0) {
    throw "Build failed for $ProgramName.o"
}

Pop-Location
